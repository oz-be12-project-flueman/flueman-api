# ëª©ì : release/* ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ ì‹¤í–‰,
#      release/x.y.z â†’ main PR ë¨¸ì§€ ì‹œ íƒœê·¸(vX.Y.Z) ìƒì„± ë° GitHub Release ë°œí–‰
# ë³´í˜¸ê·œì¹™ ë§¤í•‘:
#  - release/* ë¸Œëœì¹˜ Required check: ci/smoke

name: Release Pipeline

on:
  push:
    branches: ["release/**"] # ğŸ”” release/* ì— ì»¤ë°‹ í‘¸ì‹œë˜ë©´ ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸
  pull_request:
    types: [closed] # ğŸ”” PRì´ ë‹«í ë•Œ(ë¨¸ì§€ í¬í•¨) íƒœê¹…/ë¦´ë¦¬ìŠ¤ íŠ¸ë¦¬ê±°
    branches: [main] #    ëŒ€ìƒ: main ìœ¼ë¡œ ë¨¸ì§€ë˜ëŠ” PR
  workflow_dispatch: # ğŸ”” ìˆ˜ë™ ì‹¤í–‰(í•„ìš” ì‹œ)

permissions:
  contents: write # ğŸ”– íƒœê·¸/ë¦´ë¦¬ìŠ¤ ìƒì„± ê¶Œí•œ
  pull-requests: read

env:
  PY_VERSION: "3.12"

concurrency:
  # ë™ì¼ release/* ë˜ëŠ” íƒœê·¸ ì‘ì—…ì˜ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€
  group: release-${{ github.ref || github.run_id }}
  cancel-in-progress: true

jobs:
  # ------------------------------------------------------
  # 1) ìŠ¤ëª¨í¬ í…ŒìŠ¤íŠ¸ (release/* ë¸Œëœì¹˜ í‘¸ì‹œ ì‹œ)
  # ------------------------------------------------------
  smoke:
    if: github.event_name == 'push' && startsWith(github.ref_name, 'release/')
    name: ci/smoke # ğŸ” ë³´í˜¸ê·œì¹™ì—ì„œ ìš”êµ¬í•˜ëŠ” ì²´í¬ ì´ë¦„
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python # Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PY_VERSION }}

      - name: Cache pip # ì˜ì¡´ì„± ì„¤ì¹˜ ìºì‹œ
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-py${{ env.PY_VERSION }}-${{ hashFiles('constraints.txt','requirements.txt','requirements-dev.txt') }}
          restore-keys: ${{ runner.os }}-py${{ env.PY_VERSION }}-

      - name: Install deps (smoke) # ìš´ì˜+ê°œë°œ ì˜ì¡´ì„± + ê³µí†µ ì œì•½ ì ìš©
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt -r requirements-dev.txt -c constraints.txt

      - name: Run smoke tests # @pytest.mark.smoke ìš°ì„ , ì—†ìœ¼ë©´ ì „ì²´ ì‹¤í–‰
        run: pytest -q -m "smoke" || pytest -q

  # ------------------------------------------------------
  # 2) íƒœê·¸ & ë¦´ë¦¬ìŠ¤ (release/x.y.z â†’ main PR ë¨¸ì§€ ì‹œ)
  # ------------------------------------------------------
  tag:
    if: >
      github.event_name == 'pull_request' &&
      github.event.action == 'closed' &&
      github.event.pull_request.merged == true &&
      startsWith(github.event.pull_request.head.ref, 'release/')
    name: Tag & GitHub Release
    runs-on: ubuntu-latest
    steps:
      - name: Extract & validate version # ë¸Œëœì¹˜ëª…ì—ì„œ x.y.z ì¶”ì¶œ + SemVer ê²€ì¦
        id: ver
        shell: bash
        run: |
          BRANCH="${{ github.event.pull_request.head.ref }}"   # e.g. release/1.2.3
          VERSION="${BRANCH#release/}"
          [[ "$VERSION" =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]] || { echo "Invalid version: $VERSION"; exit 1; }
          echo "version=${VERSION}" >> "$GITHUB_OUTPUT"

      - name: Checkout (full history) # íƒœê¹…ì„ ìœ„í•´ ì „ì²´ íˆìŠ¤í† ë¦¬ í™•ë³´
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Ensure tag does not already exist # ì¤‘ë³µ íƒœê·¸ ë°©ì§€
        id: tagcheck
        shell: bash
        run: |
          TAG="v${{ steps.ver.outputs.version }}"
          if git rev-parse -q --verify "refs/tags/${TAG}" >/dev/null; then
            echo "exists=true" >> "$GITHUB_OUTPUT"
          else
            echo "exists=false" >> "$GITHUB_OUTPUT"
          fi

      - name: Create tag # ë³‘í•© ì»¤ë°‹ì— íƒœê·¸ ìƒì„±/í‘¸ì‹œ
        if: steps.tagcheck.outputs.exists == 'false'
        shell: bash
        run: |
          TAG="v${{ steps.ver.outputs.version }}"
          COMMIT="${{ github.event.pull_request.merge_commit_sha }}"
          git tag "${TAG}" "${COMMIT}"
          git push origin "${TAG}"

      - name: Create GitHub Release # ë¦´ë¦¬ìŠ¤ ë°œí–‰(ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìë™)
        if: steps.tagcheck.outputs.exists == 'false'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.ver.outputs.version }}"
          name: "Flueman API v${{ steps.ver.outputs.version }}"
          generate_release_notes: true
